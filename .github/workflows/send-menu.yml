name: Send Weekly Menu

on:
  schedule:
    # Vendredi 10:30 Paris = 9:30 UTC (heure d'hiver)
    # Vendredi 10:30 Paris = 8:30 UTC (heure d'été)
    - cron: '30 9 * * 5'  # Utilisez 9:30 UTC en hiver, ajustez en été
  
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  send-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create data directory
        run: mkdir -p data
      
      - name: Decode Google credentials
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" | base64 -d > data/credentials.json
          echo "${{ secrets.GOOGLE_TOKEN_JSON }}" | base64 -d > data/token.json
      
      - name: Create .env file
        run: |
          cat << EOF > .env
          MAMMOUTH_API_BASE=${{ secrets.MAMMOUTH_API_BASE }}
          MAMMOUTH_API_KEY=${{ secrets.MAMMOUTH_API_KEY }}
          MAMMOUTH_MODEL=${{ secrets.MAMMOUTH_MODEL }}
          SENDER_EMAIL=${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAILS=${{ secrets.RECIPIENT_EMAILS }}
          TZ=${{ secrets.TZ }}
          EOF

      - name: Run menu mailer
        env:
          TZ: Europe/Paris
          RUN_IMMEDIATELY: "true"
        run: python main.py
      
      - name: Upload logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: data/logs/
          if-no-files-found: ignore
